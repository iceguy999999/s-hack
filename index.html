<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpotiHacked</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
            box-sizing: border-box
        }
        .c {
            background: #282828;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .5);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center
        }
        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em;
            color: #1DB954;
            margin-bottom: 30px
        }
        .input-group {
            display: flex;
            margin-bottom: 20px
        }
        .input-group input[type="text"] {
            flex-grow: 1;
            padding: 15px;
            border: none;
            border-radius: 8px 0 0 8px;
            background: #3E3E3E;
            color: #fff;
            font-size: 1em
        }
        .input-group button {
            padding: 15px 25px;
            background: #1DB954;
            color: #fff;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background .2s ease
        }
        .input-group button:hover {
            background: #1AA84C
        }
        .players-container {
            margin-top: 30px;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px
        }
        .players-container::-webkit-scrollbar {
            width: 8px
        }
        .players-container::-webkit-scrollbar-track {
            background: #3E3E3E;
            border-radius: 10px
        }
        .players-container::-webkit-scrollbar-thumb {
            background: #1DB954;
            border-radius: 10px
        }
        .player-container {
            background: #3E3E3E;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap
        }
        .player-container iframe {
            flex-grow: 1;
            width: 100%;
            height: 80px;
            border: none;
            border-radius: 6px;
            margin-right: 15px;
            margin-bottom: 10px
        }
        .player-container button {
            background: #555;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: .9em;
            margin-left: 5px;
            transition: background .2s ease;
            white-space: nowrap
        }
        .player-container button:hover {
            background: #666
        }
        .delete-single-btn {
            background: #FF4D4D !important
        }
        .delete-single-btn:hover {
            background: #CC0000 !important
        }
        .download-single-btn {
            background: #007bff !important; /* A distinct color for download */
        }
        .download-single-btn:hover {
            background: #0056b3 !important;
        }
        .global-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px
        }
        .global-buttons button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background .2s ease
        }
        .clear-all-btn {
            background: #FF4D4D;
            color: #fff;
            border: none
        }
        .clear-all-btn:hover {
            background: #CC0000
        }
        .refresh-all-btn {
            background: #1DB954;
            color: #fff;
            border: none
        }
        .refresh-all-btn:hover {
            background: #1AA84C
        }
        .output-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500
        }
        .message-success {
            background: #1DB954;
            color: #fff
        }
        .message-warning {
            background: #ffc107;
            color: #333
        }
        .message-error {
            background: #dc3545;
            color: #fff
        }
        .hidden {
            display: none
        }
    </style>
</head>
<body>
    <div class="c">
        <h1>SpotiHacked</h1>
        <div class="input-group">
            <input type="text" id="urlInput" placeholder="Enter Spotify URL (track, album, playlist)">
            <button id="addPlayerBtn">Add Player</button>
        </div>
        <div class="players-container" id="playersContainer">
            </div>
        <div class="global-buttons">
            <button id="clearAllBtn" class="clear-all-btn">Clear All</button>
            <button id="refreshAllBtn" class="refresh-all-btn">Refresh All</button>
        </div>
        <div id="outputMessage" class="output-message hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('urlInput');
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            const playersContainer = document.getElementById('playersContainer');
            const refreshAllBtn = document.getElementById('refreshAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const outputMessage = document.getElementById('outputMessage');

            function displayMessage(type, message) {
                outputMessage.textContent = message;
                outputMessage.className = `output-message message-${type}`;
                outputMessage.classList.remove('hidden');
            }

            function updateGlobalButtons() {
                const hasPlayers = playersContainer.children.length > 0;
                refreshAllBtn.classList.toggle('hidden', !hasPlayers);
                clearAllBtn.classList.toggle('hidden', !hasPlayers);
            }

            addPlayerBtn.addEventListener('click', function() {
                const url = urlInput.value.trim();
                if (url) {
                    const playerContainer = document.createElement('div');
                    playerContainer.className = 'player-container';
                    playerContainer.innerHTML = `
                        <iframe src="${url}" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                        <button class="delete-single-btn">Delete</button>
                        <button class="refresh-single-btn">Refresh</button>
                        <button class="download-single-btn">Download</button> `;
                    playersContainer.appendChild(playerContainer);
                    urlInput.value = '';
                    displayMessage('success', 'Player added!');
                    updateGlobalButtons();
                } else {
                    displayMessage('warning', 'Please enter a URL.');
                }
            });

            // Handle Enter key in the input field
            urlInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    addPlayerBtn.click();
                }
            });

            // Event listener for Refresh All button
            refreshAllBtn.addEventListener('click', function() {
                const iframes = playersContainer.querySelectorAll('iframe');
                iframes.forEach(frame => {
                    frame.src = frame.src; // Reloads the iframe
                });
                displayMessage('warning', 'All players have been refreshed.');
            });

            // Event listener for Clear All button
            clearAllBtn.addEventListener('click', function() {
                playersContainer.innerHTML = '';
                displayMessage('success', 'All players have been cleared.');
                updateGlobalButtons();
            });

            // Event listener for individual player buttons (Delete, Refresh, and now Download)
            playersContainer.addEventListener('click', function(event) {
                const target = event.target;
                const playerContainer = target.closest('.player-container');
                if (!playerContainer) return;

                if (target.classList.contains('delete-single-btn')) {
                    playerContainer.remove();
                    displayMessage('warning', 'Player removed.');
                    updateGlobalButtons();
                } else if (target.classList.contains('refresh-single-btn')) {
                    const iframe = playerContainer.querySelector('iframe');
                    if (iframe) {
                        iframe.src = iframe.src;
                        displayMessage('warning', 'Player has been refreshed.');
                    }
                } else if (target.classList.contains('download-single-btn')) { // NEW DOWNLOAD LOGIC
                    const iframe = playerContainer.querySelector('iframe');
                    if (iframe && iframe.src) {
                        const spotifyUrl = iframe.src; // Get the URL from the iframe's source

                        // 1. Copy URL to clipboard
                        navigator.clipboard.writeText(spotifyUrl).then(() => {
                            displayMessage('success', 'URL copied to clipboard!');
                        }).catch(err => {
                            console.error('Failed to copy URL:', err); // Log error for debugging
                            displayMessage('error', 'Failed to copy URL to clipboard.');
                        });

                        // 2. Open the SpotiDownloader application via custom protocol
                        // Add a small delay to allow clipboard operation to initiate before redirect
                        setTimeout(() => {
                            window.location.href = 'spotidownloader://' + spotifyUrl;
                        }, 100); // 100ms delay
                    } else {
                        displayMessage('warning', 'No URL found for this player.');
                    }
                }
            });

            updateGlobalButtons(); // Initialize button visibility on load
        });
    </script>

</body>
</html>
